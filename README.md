# 🔺 ChatDB

**ChatDB** is a natural language interface for SQL and MongoDB databases. Ask questions like "List all hospitals in California" or "Add a new refugee case", and ChatDB figures out the right query for you and executes it in your local DBs.

USC DSCI 551 – Spring 2025

---

## ✨ Features

- 🔎 **Explore schemas and collections**
- 🤖 **Natural language queries** → SQL / Mongo
- 🛠️ **Insert, update, delete** across databases
- 🔄 **Cascade-aware modifications**
- 💬 **Streamlit-based chatbot UI**
- 🧠 Powered by **LangChain** + **OpenAI** 

---

## 🚀 Setup Instructions

### 1. Clone the repo and install dependencies

```bash
git clone https://github.com/yourusername/chatdb.git
cd chatdb
```

Install the required packages using pip:

```bash
pip install -r requirements.txt
```
or 
```bash
pip install \
    streamlit \
    streamlit-chat \
    python-dotenv \
    psycopg2-binary \
    sqlalchemy \
    pymongo \
    langchain \
    langchain-openai \
    langchain-community \
    pydantic \
    pandas
```

### 2. Set up environment variables

Create a `.env` file in the root directory based on the `.env.template` file. Fill in the required variables. 
You might need to get API keys from OpenAI and Langsmith if you want to use them.

### 3. Prepare the DBs. 

#### **PostgreSQL**
- Create a database named `healthcare`
- Run the following to import schema and data
    ```bash
    python sql_import.py
    ```

This will:
- Run data/CREATE_TABLES.sql to create tables
- Import data from:
  - data/hospitals.csv
  - data/doctors.csv
  - data/patients.csv
  - data/admissions.csv
- Reset Serial counters for the ID columns

#### **MongoDB**
- Run the following to import schema and data
    ```bash
    python mongo_import.py
    ```
This will:
- Import JSONs into the refugees database:
  - data/refugee_cases.json
  - data/refugee_exams.json
  - data/nested_psychosocial_assessment_data.json

### 4. Run the Streamlit app
To start the Streamlit app, run the following command in your terminal:
    ```bash
    streamlit run app.py
    ```

To run the app in test mode. Use the file Test_Cases_for_ChatDB.csv and add prompts in the prompt column. Set the `TEST_MODE` environment variable to `true` in your `.env` file. Then run the app as follows:

    ```bash
    python app.py
    ```

### 5. Open your browser and navigate to `http://localhost:8501`
You should see the ChatDB interface.    
Type your queries in the input box and hit enter to see the results.

## Example Queries
- List all available databases.
- What tables are in the healthcare database?
- Show me the schema for the admissions table in healthcare.
- Give me a sample of the refugee_exams collection.
- Show all hospitals.
- Find all doctors working at hospital_id 3.
- Get names of all patients over age 60.
- List patient names and hospital names for all admissions.
- Show total billing_amount by hospital in 2024.
- Show me refugee cases where support_services is missing.
- Find all refugee cases joined with exams.
- Add a new hospital called 'Sunrise Hospital'.
- Add a new doctor Dr. Green to hospital 2.
- Add a refugee case with applicant 'Ali', status 'pending'.
- Add a refugee case and also the required exams in refugee_exams.
- Add patient but forget age.
- Update hospital 1 name to 'New Hope'.
- Change blood_type to 'AB+' for patient 4.
- Update refugee case 101 status to approved and related exams required - field.
- Update hospital name without giving ID.
- Delete hospital with id 3.
- Delete patient named John Doe.
- Delete refugee case with case_id 999.
- Delete refugee case and all related exams.
- Delete admissions but forgot to give condition.

## 🧠 Architecture Overview
- LangChain: Prompt + tool orchestration
- OpenAI : LLM for reasoning and generation
- SQLAlchemy / PyMongo: DB execution layer
- Streamlit: Frontend chat interface
- LangSmith: Tracing and debugging

## 📦 Folder Structure
```
chatdb/
│
├── app.py                      # main Streamlit app
├── sql_import.py               # schema + csv importer
├── mongo_import.py             # mongo json importer
├── global_db_state.json        # loaded DB schema. generated by the app
├── data/                       # CSVs, SQL, and JSON files
├── .env.template               # environment variable config
├── requirements.txt
└── README.md
```

### 👩‍💻 Authors
- Gleice Chaves

